<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevressurser | Bergen Private Gymnas</title>
    <!-- Metis Design System - Tema-variabler -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Metis-Utdanning/metis-design_system@main/dist/themes/bpg.css" id="metis-theme">
    <!-- Lokal styling -->
    <link rel="stylesheet" href="https://metis-utdanning.github.io/test-bpg-elevside_via_github/css/styles.css">
    <script src="https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js"></script>
</head>
<body data-theme="bpg">
    <!-- Theme Switcher (for testing) -->
    <div class="theme-switcher">
        <button class="active" data-theme="bpg" onclick="setTheme('bpg')">
            <span class="dot" style="background:#1F4739"></span>BPG
        </button>
        <button data-theme="metis-vgs" onclick="setTheme('metis-vgs')">
            <span class="dot" style="background:#EE2737"></span>VGS
        </button>
        <button data-theme="privatist" onclick="setTheme('privatist')">
            <span class="dot" style="background:#00b398"></span>Privatist
        </button>
        <button data-theme="privatlarer" onclick="setTheme('privatlarer')">
            <span class="dot" style="background:#FF8000"></span>PL
        </button>
        <button data-theme="metis" onclick="setTheme('metis')">
            <span class="dot" style="background:#188AAD"></span>Metis
        </button>
    </div>

    <div class="container">
        <header class="header">
            <div class="header__top">
                <span class="header__badge">Bergen Private Gymnas</span>
            </div>
            <h1 class="header__title">Elev<span class="highlight">ressurser</span></h1>
        </header>

        <main class="grid">
            <!-- Nyheter -->
            <section class="panel panel--news">
                <div class="panel__header">
                    <h2 class="panel__title">Siste nytt</h2>
                    <a href="https://www.bergenprivategymnas.no/nyhetsbrev" target="_blank" rel="noopener" class="panel__link">
                        Alle nyheter <span class="arrow">→</span>
                    </a>
                </div>
                <div class="news" id="newsFeed">
                    <div class="news__skeleton">
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line skeleton-line--short"></div>
                    </div>
                </div>
            </section>

            <!-- Snarveier -->
            <section class="panel panel--links">
                <div class="panel__header">
                    <h2 class="panel__title">Snarveier</h2>
                </div>
                <nav class="links">
                    <a href="https://bergen-privategymnas.inschool.visma.no/" target="_blank" rel="noopener" class="card card--primary">
                        <div class="card__content">
                            <h3 class="card__title">InSchool</h3>
                            <p class="card__desc">Timeplan, fravær og karakterer</p>
                        </div>
                        <span class="card__arrow">→</span>
                    </a>

                    <a href="https://metisutdanning.sharepoint.com/sites/BPG-Elev" data-teams-internal class="card">
                        <div class="card__content">
                            <h3 class="card__title">Elevsiden</h3>
                            <p class="card__desc">Informasjon og ressurser for elever</p>
                        </div>
                        <span class="card__arrow">→</span>
                    </a>

                    <a href="https://metisutdanning-my.sharepoint.com/my" data-teams-internal class="card">
                        <div class="card__content">
                            <h3 class="card__title">Mine filer</h3>
                            <p class="card__desc">OneDrive – dine dokumenter</p>
                        </div>
                        <span class="card__arrow">→</span>
                    </a>

                    <a href="https://metis.checkid.no/v2" target="_blank" rel="noopener" class="card">
                        <div class="card__content">
                            <h3 class="card__title">Ny mobil / Passord</h3>
                            <p class="card__desc">Tilbakestill eller registrer enhet</p>
                        </div>
                        <span class="card__arrow">→</span>
                    </a>

                    <a href="https://www.metisutdanning.no/it-informasjon" target="_blank" rel="noopener" class="card">
                        <div class="card__content">
                            <h3 class="card__title">IT-hjelp</h3>
                            <p class="card__desc">Veiledninger og support</p>
                        </div>
                        <span class="card__arrow">→</span>
                    </a>

                    <a href="https://metispl.no/bookingsider" target="_blank" rel="noopener" class="card">
                        <div class="card__content">
                            <h3 class="card__title">Bestill privatlærer</h3>
                            <p class="card__desc">Book time med privatlærer</p>
                        </div>
                        <span class="card__arrow">→</span>
                    </a>
                </nav>
            </section>
        </main>

        <footer class="footer">
            <div class="footer__line"></div>
            <p class="footer__text">
                <span class="footer__org">Metis Utdanning</span> · Bergen Private Gymnas
            </p>
        </footer>
    </div>

    <script>
        // Teams SDK
        (function() {
            const setupLinks = (openInTeams) => {
                document.querySelectorAll('[data-teams-internal]').forEach(link => {
                    if (openInTeams) {
                        link.addEventListener('click', e => {
                            e.preventDefault();
                            window.open(link.href, '_top');
                        });
                    } else {
                        link.target = '_blank';
                        link.rel = 'noopener';
                    }
                });
            };

            if (window.microsoftTeams) {
                microsoftTeams.app.initialize()
                    .then(() => setupLinks(true))
                    .catch(() => setupLinks(false));
            } else {
                setupLinks(false);
            }
        })();

        // RSS Feed med regex-parsing
        async function loadNews() {
            const container = document.getElementById('newsFeed');
            if (!container) return;

            try {
                const rssUrl = 'https://www.bergenprivategymnas.no/nyhetsbrev?format=rss';
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(rssUrl);

                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error('Fetch failed');

                const xml = await res.text();
                if (!xml) throw new Error('No contents');

                // Regex for å finne items (med multiline support)
                const itemRegex = /<item>[\s\S]*?<\/item>/gi;
                const itemMatches = xml.match(itemRegex) || [];
                const items = [];

                for (let i = 0; i < Math.min(itemMatches.length, 4); i++) {
                    const itemXml = itemMatches[i];

                    // Hent title (med eller uten CDATA)
                    const titleMatch = itemXml.match(/<title>(?:<!\[CDATA\[)?(.*?)(?:\]\]>)?<\/title>/is);
                    // Hent link
                    const linkMatch = itemXml.match(/<link>\s*(https?:\/\/[^\s<]+)\s*<\/link>/i);
                    // Hent dato
                    const dateMatch = itemXml.match(/<pubDate>([^<]+)<\/pubDate>/i);
                    // Hent bilde fra media:content
                    const imageMatch = itemXml.match(/<media:content[^>]+url="([^"]+)"/i);

                    const title = titleMatch ? titleMatch[1].trim() : 'Uten tittel';
                    const link = linkMatch ? linkMatch[1].trim() : '#';
                    const pubDate = dateMatch ? dateMatch[1].trim() : null;
                    const image = imageMatch ? imageMatch[1].replace(/\?format=\d+w/, '?format=500w') : null;

                    let date = '';
                    if (pubDate) {
                        const d = new Date(pubDate);
                        if (!isNaN(d)) {
                            date = d.toLocaleDateString('no-NO', { day: 'numeric', month: 'short' }).replace('.', '');
                        }
                    }

                    items.push({ title, link, date, image });
                }

                if (items.length === 0) throw new Error('No items found');

                container.innerHTML = items.map(item => `
                    <a href="${item.link}" target="_blank" rel="noopener" class="news__card">
                        ${item.image ? `<div class="news__image"><img src="${item.image}" alt="" loading="lazy"></div>` : ''}
                        <div class="news__body">
                            <time class="news__date">${item.date}</time>
                            <h3 class="news__title">${item.title}</h3>
                        </div>
                    </a>
                `).join('');

            } catch (e) {
                console.error('RSS feil:', e);
                container.innerHTML = `
                    <a href="https://www.bergenprivategymnas.no/nyhetsbrev" target="_blank" rel="noopener" class="news__fallback">
                        Se nyheter på nettsiden <span class="arrow">→</span>
                    </a>
                `;
            }
        }

        // Kjør når DOM er klar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadNews);
        } else {
            loadNews();
        }

        // Theme Switcher - Metis Design System
        const themeNames = {
            'bpg': 'Bergen Private Gymnas',
            'metis-vgs': 'Metis Videregående',
            'privatist': 'Metis Privatist',
            'privatlarer': 'Metis Privatlærer',
            'metis': 'Metis Utdanning'
        };

        function setTheme(themeId) {
            // Bytt CSS-fil
            const themeLink = document.getElementById('metis-theme');
            themeLink.href = `https://cdn.jsdelivr.net/gh/Metis-Utdanning/metis-design_system@main/dist/themes/${themeId}.css`;

            // Oppdater data-theme
            document.body.setAttribute('data-theme', themeId);

            // Oppdater knapper
            document.querySelectorAll('.theme-switcher button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === themeId);
            });

            // Oppdater badge-tekst
            const badge = document.querySelector('.header__badge');
            if (badge && themeNames[themeId]) {
                badge.textContent = themeNames[themeId];
            }

            // Lagre preferanse
            localStorage.setItem('elevside-theme', themeId);
        }

        // Last lagret tema
        const savedTheme = localStorage.getItem('elevside-theme');
        if (savedTheme && themeNames[savedTheme]) {
            setTheme(savedTheme);
        }
    </script>
</body>
</html>
